name: ffmpeg-al2023-arm64

on:
  workflow_dispatch:
    #manual trigger

jobs:
  buildx:
    runs-on: ubuntu-latest
    env:
      TIMESTAMP: ${{ github.run_id }}_${{ github.run_number }}
      ARCH: arm64
      CONFIG_DIR: configs/ffmpeg-for-lambda
      DOCKERFILE: configs/ffmpeg-for-lambda/Dockerfile.arm64
      ZIP_NAME: ffmpeg-arm64.zip

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Create directory structure
        run: |
          mkdir -p build/${TIMESTAMP}/${ARCH}/bin
          mkdir -p build/archive/${TIMESTAMP}

      - name: Generate ffmpeg_version.sh
        run: |
          VERSION_STRING="lambda-${ARCH}-${TIMESTAMP}"

          echo "Generating version script with version: ${VERSION_STRING}"

          cat <<-EOF > ${CONFIG_DIR}/ffmpeg_version.sh
          #!/bin/sh
          echo "${VERSION_STRING}"
          exit 0
          EOF

          chmod +x ${CONFIG_DIR}/ffmpeg_version.sh
          echo "ffmpeg_version.sh created in ${CONFIG_DIR}"

      - name: Build Docker image
        run: |
          echo "Building FFmpeg for ${ARCH}..."
          echo "Building Docker image for ${ARCH}..."
          docker buildx build \
            --platform linux/arm64 \
            -t ffmpeg-${ARCH}-builder \
            -f ${DOCKERFILE} ${CONFIG_DIR} --load

      - name: Extract binaries from container
        run: |
          echo "Extracting FFmpeg binaries from container..."
          container_id=$(docker create ffmpeg-${ARCH}-builder)

          docker logs $container_id > build/${TIMESTAMP}/${ARCH}/build.log 2>&1

          docker cp $container_id:/ffmpeg_build/bin/ffmpeg build/${TIMESTAMP}/${ARCH}/bin/
          docker cp $container_id:/ffmpeg_build/bin/ffprobe build/${TIMESTAMP}/${ARCH}/bin/

          docker rm $container_id > /dev/null

          chmod +x build/${TIMESTAMP}/${ARCH}/bin/ffmpeg build/${TIMESTAMP}/${ARCH}/bin/ffprobe

          echo "Extraction complete for ${ARCH}!"
          echo "FFmpeg binaries are available in the build/${TIMESTAMP}/${ARCH}/bin directory"
          ls -lh build/${TIMESTAMP}/${ARCH}/bin/

      - name: Create deployment package
        run: |
          echo "Creating deployment package for ${ARCH}..."

          zip_name_with_timestamp=${ZIP_NAME/.zip/_${TIMESTAMP}.zip}
          zip_path_with_timestamp="build/archive/${TIMESTAMP}/${zip_name_with_timestamp}"

          ln -sf "${zip_name_with_timestamp}" "build/archive/${TIMESTAMP}/${ZIP_NAME}"

          cd build/${TIMESTAMP}/${ARCH}
          zip -r "${GITHUB_WORKSPACE}/build/archive/${TIMESTAMP}/${zip_name_with_timestamp}" bin/
          cd - > /dev/null

          if [ -f "${CONFIG_DIR}/readme.md" ]; then
            echo "Copying readme.md to build/archive/${TIMESTAMP}/ffmpeg-${ARCH}-readme.md"
            cp "${CONFIG_DIR}/readme.md" "build/archive/${TIMESTAMP}/ffmpeg-${ARCH}-readme.md"
          fi

          echo "Deployment package created: ${zip_name_with_timestamp}"
          echo "Package location: build/archive/${TIMESTAMP}/${zip_name_with_timestamp}"
          ls -lh "build/archive/${TIMESTAMP}/${zip_name_with_timestamp}"

      - name: Create build info
        run: |
          echo "Build completed at: $(date)" > "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          echo "Architecture: ${ARCH}" >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          echo "Configuration: ${CONFIG_DIR}" >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          echo "Dockerfile: ${DOCKERFILE}" >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          echo "Binary sizes:" >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          ls -lh build/${TIMESTAMP}/${ARCH}/bin/ >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"
          echo "Zip package: build/archive/${TIMESTAMP}/${ZIP_NAME/.zip/_${TIMESTAMP}.zip}" >> "build/${TIMESTAMP}/${ARCH}/build_info.txt"

      - name: Create build summary
        run: |
          echo "Creating build summary..."
          cat > "build/${TIMESTAMP}/summary.txt" << EOF
          FFmpeg Build Summary
          ===================
          Build ID: ${TIMESTAMP}
          Date: $(date)

          This build includes:
          - ARM64 binaries for Amazon lambda/provided:al2023
          - Configuration: ${CONFIG_DIR}

          Archives:
          - build/archive/${TIMESTAMP}/${ZIP_NAME/.zip/_${TIMESTAMP}.zip}

          Build logs and binaries are stored in subdirectories.
          EOF

          cp "build/${TIMESTAMP}/summary.txt" "build/archive/${TIMESTAMP}/"

          echo "${TIMESTAMP}" > "build/latest.txt"

          echo "Build completed successfully!"
          echo "Build outputs stored in: build/${TIMESTAMP}"
          echo "Archives stored in: build/archive/${TIMESTAMP}"

      - name: Clean up Docker images
        run: |
          docker rmi ffmpeg-${ARCH}-builder
          echo "Docker images removed."

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ffmpeg-${ARCH}-build
          path: build/archive/${TIMESTAMP}
          retention-days: 7
